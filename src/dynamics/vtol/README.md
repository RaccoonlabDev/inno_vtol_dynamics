# VTOL Dynamics

## 1 Mathematical Model

The mathematical model underpinning our VTOL (Vertical Take-Off and Landing) dynamics simulator adheres to the 6DOF (six-degrees-of-freedom) rigid body dynamics. This model characterizes an object's movement in three-dimensional space, accounting for both translational and rotational degrees of freedom.

### 1.1 Kinematics

In the kinematics portion of our model, we concern ourselves with the geometric aspects of the VTOL's motion, exclusive of the forces causing the movement.
We primarily deal with the following state variables:

- **Position (r)**: A 3D vector denoting the VTOL's location in space.

$$ r = [x, y, z]^T $$
  
- **Velocity (V)**: The first time derivative of the position.

  $$ V = \frac{dr}{dt} = [\dot{x}, \dot{y}, \dot{z}]^T $$
  
- **Attitude (q)**: A quaternion representing the VTOL's orientation in space.

  $$ q = [q_w, q_x, q_y, q_z]^T $$
  
- **Angular velocity (ω)**: The time derivative of the attitude.

  $$ \omega = [\omega_x, \omega_y, \omega_z]^T $$

The kinematic equations relating these variables are:

- The derivative of position is equal to the velocity.

  $$ \frac{dr}{dt} = V $$

- The derivative of quaternion is related to the angular velocity.

  $$ \frac{dq}{dt} = 0.5 * [0, \omega] \otimes q $$

where:

- $dr/dt$ and $dq/dt$ are time derivatives of position and attitude respectively.
- $\otimes$ represents the quaternion multiplication.

### 1.2 Dynamics

Dynamics describes how forces and moments influence the motion of the vehicle. In a typical VTOL aircraft model, the main forces acting are 
- thrust produced by the propellers, 
- gravitational forces, 
- and aerodynamic forces. 

The equations governing these forces and moments are the Newton's second law of motion and Euler's equations for rotating bodies. 

In a 6DOF (six degrees of freedom) model, we include translational motion in three directions and rotational motion about three axes. The differential equations of motion in vector form can be written as follows:

#### 1.2.1 Translational Motion

The net force acting on the vehicle is equal to the mass times the acceleration, or the derivative of linear momentum. 

$$ \frac{d(mV)}{dt} = F_{total} = F_{thrust} + F_{gravity} + F_{aero}$$

Here:
- $m$ is the mass of the aircraft.
- $V$ is the velocity vector of the center of mass.
- $F_{total}$ is the total force acting on the vehicle.
- $F_{thrust}$ is the total thrust force produced by the motors.
- $F_{gravity}$ is the gravity force acting on the vehicle, typically $F_{gravity} = m*g$ where $g$ is the acceleration due to gravity.
- $F_{aero}$ is the total aerodynamic force.

#### 1.2.2 Rotational Motion

The net moment or torque $τ$ about the center of mass is equal to the derivative of angular momentum, which is expressed by Euler's equations.

$$ \frac{d(I\omega)}{dt} = \tau_{total} = \tau_{thrust} + \tau_{aero}$$

Here:
- $I$ is the inertia tensor.
- $ω$ is the angular velocity vector.
- $τ_{total}$ is the total moment acting on the vehicle.
- $τ_{thrust}$ is the moment generated by the motors.
- $τ_{aero}$ is the aerodynamic moment.

The aerodynamics, thrust dynamics, and conversions from RPM to force will be covered in subsequent sections.

## 1.3 Aerodynamics

Our model implements a data-driven and empirical approach, where aerodynamic forces and moments are computed based on precomputed coefficients. These coefficients have been obtained using CFD simulations and are functions of airspeed, angles of attack, sideslip, and control surface positions. The use of these coefficients allows us to encapsulate complex aerodynamic phenomena into a manageable set of equations.


Aerodynamic forces, i.e., lift, drag, and sideslip forces, can be described by the following equations:

$$ F_{lift} = \frac{1}{2} \cdot q \cdot C_{L_{\alpha}} $$
$$ F_{drag} = \frac{1}{2} \cdot q \cdot C_{D_{\alpha}} $$
$$ F_{sideslip} = \frac{1}{2} \cdot q \cdot (C_{S_{\alpha}} + C_{S_{\beta}} + C_{S_r}) $$

Where:
- $q = \rho \cdot V^2 \cdot S$ is the dynamic pressure with $\rho$ as atmosphere pressure, $V$ as airspeed, and $S$ as wing area.
- $C_{L_{\alpha}}, C_{D_{\alpha}}, C_{S_{\alpha}}, C_{S_{\beta}}$, and $C_{S_r}$ are coefficients of lift, drag, and sideslip forces, respectively, depending on various factors like airspeed, angle of attack, sideslip angle, and rudder angle.

Similarly, aerodynamic moments, divided into two terms, depend on airspeed, angle of attack, and control surface positions:

$$ M_{x} = \frac{1}{2} \cdot q \cdot l \cdot (C_{mx} + C_{mxa} \cdot {\delta}_{a}) $$
$$ M_{y} = \frac{1}{2} \cdot q \cdot l \cdot (C_{my} + C_{mye} \cdot {\delta}_{e}) $$
$$ M_{z} = \frac{1}{2} \cdot q \cdot l \cdot (C_{mz} + C_{mzr} \cdot {\delta}_{r})  $$

Where:
- $l$ is the characteristic length,
- $C_{mx}, C_{my}, C_{mz}$ are coefficients defining the first term,
- $C_{mxa}, C_{mye}, C_{mzr}$ are coefficients describing the second term,
- $\delta_{a}, \delta_{e}, \delta_{r}$ are aileron, elevator, and rudder positions respectively.

The coefficients mentioned here are a part of the broader list of aerodynamic coefficients which vary with airspeed, angle of attack (AoA), angle of sideslip (AoS), and control surface positions.

These aerodynamics characteristics are stored in a data configuration file like `aerodynamics_coeffs.yaml` and determined using CFD for a range of airspeeds, AoA, and AoS. 

To derive aerodynamic forces and moments, a function `calculateAerodynamics` is used. It takes the airspeed vector, angles of attack and sideslip values (AoA, AoS), aerodynamic surfaces positions (aileron_pos, elevator_pos, rudder_pos) and calculates the aerodynamic forces and moments vectors (Faero, Maero).

For a detailed understanding of the aerodynamics, you can refer to the complete description in the [aerodynamics.md](./aerodynamics.md) file.


## 1.4 Environment Model

The environment model in the `InnoVtolDynamicsSim` class consists of the following components:

### 1.4.1 Wind Model

The wind velocity is a vector represented by Gaussian noise around a set mean value. The wind in each direction (x, y, z) is calculated as follows:

$$W_{i} = \sqrt{Var} * Rand() + \mu_{i}$$

where:
- $W_{i}$ is the wind velocity in the i-th direction,
- $\sqrt{Var}$ is the standard deviation of the wind,
- $Rand()$ is a random number following the standard normal distribution,
- $\mu_{i}$ is the mean wind velocity in the i-th direction.

The gust is currently not implemented and is set to zero.

### 1.4.2 Atmospheric Model

It is assumed to be constant in this model. It's used in calculating the dynamic pressure, $q$, as follows: 

$$q = \rho * V^2 * S$$

where:
- $q$ is the dynamic pressure,
- $\rho$ is the atmospheric density,
- $V$ is the airspeed,
- $S$ is the wing area.

Note that this is a simplified model, and in more complex models, factors like atmospheric density variation with altitude and temperature, as well as wind's temporal and spatial correlations, can be taken into account.


## 1.5 Motors model

The motors model module of the software handles the calculations that link motor actuator commands to physical forces and torques.

The `updateActuators` function is effectively performing a first-order exponential decay operation on the change in the actuator commands. Given an actuator command $cmd_{new}$, previous actuator state $cmd_{old}$, and a time constant $\tau$, the updated actuator command $cmd_{upd}$ is calculated as:

$$cmd_{upd} = cmd_{old} + (cmd_{new} - cmd_{old}) \cdot (1 - e^{-\frac{dt}{\tau}})$$

where:

- $cmd_{new}$ is the new command input,
- $cmd_{old}$ is the previous state of the actuator (saved in `state_.prevActuators`),
- $dt$ is the time step since the last update,
- $\tau$ is the time constant associated with each actuator (found in `tables_.actuatorTimeConstants`),
- $e$ is the base of natural logarithms.

This formula applies an exponential decay factor to the change in actuator command, effectively creating a low-pass filter that smooths out changes in the actuator command over time. The time constant $\tau$ determines the rate of this smoothing: a smaller $\tau$ results in faster decay (more smoothing), while a larger $\tau$ results in slower decay (less smoothing).

 `thruster()` function function takes an actuator command and outputs the corresponding thrust, torque, and rotational speed (RPM) of the motor. It uses lookup tables (tables_.prop) defined in the parameters to map between actuator commands and the corresponding outputs. The function uses linear interpolation between the two nearest lookup table entries to provide a smooth transition between different actuator commands.


# 2 Software Structure

The `UavDynamicsSimBase` class acts as the primary interface to our VTOL dynamics simulator. It encapsulates the core functionalities of the simulator, providing a robust framework for handling the simulation process.

The class includes the following key methods:

- `process()`: This function accepts a time step as input, applies the equations of motion, and updates the state of the VTOL accordingly.

- State description methods:
    - `getVehiclePosition()`: Returns the 3D position vector of the vehicle.
    - `getVehicleAttitude()`: Returns the quaternion representing the vehicle's attitude.
    - `getVehicleVelocity()`: Returns the 3D linear velocity vector.
    - `getVehicleAngularVelocity()`: Returns the 3D angular velocity vector.
    - `getIMUMeasurement()`: Outputs the IMU (Inertial Measurement Unit) readings, which include accelerations and angular velocities.
    - `getMotorsRpm()`: Returns the current RPM (rotations per minute) for each of the VTOL's motors.



The `InnoVtolDynamicsSim` class is derived from the `UavDynamicsSimBase` class, inheriting all the base features and adding additional functionality specific to the VTOL model. It contains mechanisms to handle the dynamics simulation of the VTOL system, including forces and moments calculation, state updating.

The class comprises the following key methods:

- `process()`: This method, inherited from the base class, accepts the actuator input, updates the state of the VTOL using the dynamics equations, and incorporates aerodynamic properties and environmental effects like wind into the simulation.
- `calculateNewState()`: This is the core function that updates the state of the VTOL based on the provided aerodynamic forces, aerodynamic moments, actuator outputs, and time step.
- calibrate(): This method is used to simulate the mag sensor calibration process
- 'updateActuators()' function simulates motors dynamics;
- `calculateAerodynamics()` and others like `calculateDynamicPressure()`, `calculateAnglesOfAttack()`, `calculateAnglesOfSideslip()`, `calculate**Polynomial()`, etc are used to compute the aerodynamic forces and moments acting on the VTOL
- `thruster()` function calculates the thrust, torque, and RPM for each motor based on the actuator command.

This class provides a comprehensive framework for simulating the flight dynamics of a VTOL system. It accounts for all major forces and moments that would act on the VTOL in a real-world scenario, including those from the propulsion system, aerodynamics, and environmental factors, making it an ideal tool for testing control algorithms in a simulation environment before deploying them on a real VTOL.


# 3 Parameters and Configuration

The VTOL dynamics simulation is highly configurable, allowing users to specify a wide variety of parameters. These parameters are encapsulated in two main structs: `VtolParameters` and `TablesWithCoeffs`.

## 3.1 VtolParameters

`VtolParameters` is the primary container for physical properties and performance characteristics of the VTOL. The struct includes:

- `mass`: Mass of the vehicle in kilograms (kg).
- `gravity`: Acceleration due to gravity (standard is 9.81 m/s^2).
- `atmoRho`: Atmospheric air density in kilograms per cubic meter (kg/m^3).
- `wingArea`: Wing area in square meters (m^2).
- `characteristicLength`: Characteristic length in meters (m).
- `inertia`: 3x3 inertia matrix in kilogram meter squared (kg*m^2).
- `propellersLocation`: An array of 3D vectors describing the location of the propellers.
- `actuatorMin` and `actuatorMax`: Vectors describing the minimum and maximum possible radian values per second for each actuator respectively.
- `deltaControlMax`: An array describing the maximum control change per second (rad/sec^2).
- `timeConstant`: An array describing the time constants (in seconds) for the actuators.
- `accVariance` and `gyroVariance`: Variances for accelerometer and gyroscope readings respectively.
- `massUncertainty` and `inertiaUncertainty`: Multipliers representing uncertainty in mass and inertia respectively.
- `accelBias` and `gyroBias`: Bias in accelerometer and gyroscope readings respectively.

## 3.2 TablesWithCoeffs

`TablesWithCoeffs` holds all the tables with coefficients necessary for simulation:

- `CS_rudder`, `CS_beta`, `AoA`, `AoS`, `actuator`, `airspeed`, `CLPolynomial`, `CSPolynomial`, `CDPolynomial`, `CmxPolynomial`, `CmyPolynomial`, `CmzPolynomial`, `CmxAileron`, `CmyElevator`, `CmzRudder`, `prop`: Various matrices and vectors storing coefficients for various aerodynamics calculations.
- `actuatorTimeConstants`: Vector storing time constants for each actuator.

More details about the structure and meaning of the aerodynamics tables can be found in the [aerodynamics.md](./aerodynamics.md) file.

To configure the simulator, users should create an instance of `VtolParameters` and `TablesWithCoeffs`, populate them with the desired parameters and coefficients, and pass them to the `InnoVtolDynamicsSim` class during initialization.